<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="è°æ˜¯å§åº•åœ¨çº¿æ¸¸æˆ - è‰é›¯ç‰ˆï¼Œæ”¯æŒå¤šç§æ¸¸æˆæ¨¡å¼ã€è¯­éŸ³æç¤ºå’Œæ™ºèƒ½è£åˆ¤">
    <meta name="keywords" content="è°æ˜¯å§åº•">
    <title>è°æ˜¯å§åº• - è‰é›¯ç‰ˆ</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==================== ä¸»é¢˜å˜é‡ ==================== */
        :root{
            /* é»˜è®¤ä¸»é¢˜ï¼ˆå¯é€šè¿‡è„šæœ¬åŠ¨æ€è¦†ç›–ï¼‰ */
            --primary:#6c5ce7;--danger:#ff7675;--success:#55efc4;--warning:#fdcb6e;--info:#74b9ff;
            --bg:#0f0c29;--text:#fff;
        }
        body{
            background:linear-gradient(135deg,var(--bg),#302b63,#24243e);
            color:var(--text);
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            margin:0;padding:20px;min-height:100vh;transition:all .3s ease;
        }
        .game-container{display:grid;grid-template-columns:320px 1fr;gap:20px;max-width:1200px;margin:0 auto;transition:all .3s ease;}
        .panel{background:rgba(255,255,255,.08);padding:20px;border-radius:20px;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,.3);transition:all .3s ease;}
        .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:20px;}
        .card{height:200px;perspective:1000px;cursor:pointer;transition:transform .3s ease,box-shadow .3s ease;}
        .card:hover:not(.flipped):not(.locked):not(.out){transform:translateY(-5px) scale(1.02);box-shadow:0 10px 20px rgba(0,0,0,.3);}
        .card-inner{position:relative;width:100%;height:100%;transition:transform .8s cubic-bezier(.175,.885,.32,1.275);transform-style:preserve-3d;}
        .card.flipped .card-inner{transform:rotateY(180deg);}
        .card.locked{opacity:.4;filter:blur(3px);pointer-events:none;}
        .card.out{opacity:.3;pointer-events:none;filter:grayscale(1) brightness(.7);transform:scale(.95);}
        .card.viewed .front::after{content:"âœ“";position:absolute;top:10px;right:10px;color:var(--success);font-size:20px;}
        .front,.back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,.15);transition:all .3s;}
        .front{background:linear-gradient(145deg,#2d2d44,#1a1a2e);color:var(--primary);font-size:36px;font-weight:bold;}
        .back{transform:rotateY(180deg);color:#000;font-weight:bold;text-align:center;padding:15px;}
        .back.civilian{background:linear-gradient(145deg,var(--success),#00b894);box-shadow:inset 0 0 20px rgba(0,0,0,.1);}
        .back.undercover{background:linear-gradient(145deg,var(--danger),#d63031);color:#fff;box-shadow:inset 0 0 20px rgba(0,0,0,.2);}
        .back.blank{background:linear-gradient(145deg,#a29bfe,#6c5ce7);color:#fff;}
        .back h3{margin:10px 0;font-size:22px;text-shadow:1px 1px 3px rgba(0,0,0,.3);}
        .back small{font-size:14px;padding:5px 12px;background:rgba(0,0,0,.2);border-radius:20px;margin-bottom:5px;}
        .btn{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;font-weight:bold;margin-top:10px;font-size:16px;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;}
        .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.3);}
        .btn-main{background:linear-gradient(145deg,var(--primary),#5b4fcf);color:#fff;}
        .btn-vote{background:linear-gradient(145deg,var(--danger),#e66767);color:#fff;}
        .btn-success{background:linear-gradient(145deg,var(--success),#00b894);color:#000;}
        .btn-warning{background:linear-gradient(145deg,var(--warning),#f39c12);color:#000;}
        .btn-info{background:linear-gradient(145deg,var(--info),#0984e3);color:#fff;}
        .btn:disabled{background:#444;cursor:not-allowed;opacity:.5;}
        input,select,textarea{width:100%;padding:12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;margin:10px 0;font-size:16px;}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(108,92,231,.3);}
        #log{font-size:13px;color:#aaa;margin-top:20px;height:150px;overflow-y:auto;background:rgba(0,0,0,.3);padding:15px;border-radius:10px;border:1px solid rgba(255,255,255,.1);}
        #log div{padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05);}
        #log div:first-child{color:var(--primary);font-weight:bold;}
        .stats{display:flex;justify-content:space-between;background:rgba(0,0,0,.2);padding:15px;border-radius:10px;margin:15px 0;}
        .stat-item{text-align:center;}
        .stat-value{font-size:24px;font-weight:bold;}
        .stat-label{font-size:12px;color:#aaa;}
        .phase-indicator{padding:8px 15px;border-radius:20px;font-size:14px;font-weight:bold;margin:10px 0;text-align:center;background:rgba(108,92,231,.2);border:1px solid var(--primary);}
        .last-words{background:rgba(0,0,0,.3);padding:15px;border-radius:10px;text-align:center;margin:10px 0;font-size:16px;color:var(--warning);border:1px solid var(--warning);display:none;}
        .last-words.active{display:block;animation:lastWordsPulse 1s infinite alternate;}
        @keyframes lastWordsPulse{from{box-shadow:0 0 10px var(--warning);}to{box-shadow:0 0 20px var(--warning);}}
        .setting-group{margin-bottom:15px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px;}
        .setting-title{font-size:14px;color:var(--primary);margin-bottom:5px;display:flex;align-items:center;gap:8px;}
        .advanced-settings{max-height:0;overflow:hidden;transition:max-height .3s ease-out;margin-top:10px;}
        .advanced-settings.expanded{max-height:800px;}
        .manual-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:none;z-index:2000;overflow-y:auto;padding:20px;backdrop-filter:blur(10px);}
        .manual-overlay.show{display:block;}
        .manual-content{max-width:800px;margin:0 auto;background:rgba(255,255,255,.1);border-radius:20px;padding:30px;border:1px solid rgba(255,255,255,.2);}
        .manual-section{margin-bottom:30px;padding:20px;background:rgba(0,0,0,.3);border-radius:15px;}
        .manual-section h3{color:var(--primary);margin-top:0;}
        
        /* ==================== å·¦ä¸Šè§’æ§åˆ¶æŒ‰é’® ==================== */
        .top-left-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
        
        .sound-control {
            background: rgba(0,0,0,.6);
            border-radius: 8px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,.1);
        }
        
        .help-icon {
            background: rgba(108,92,231,.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all .3s ease;
            font-size: 20px;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            border: 1px solid rgba(255,255,255,.2);
        }
        
        .help-icon:hover {
            background: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(108,92,231,.4);
        }
        
        #soundToggle {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
            background: rgba(255,255,255,.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,.2);
            border-radius: 8px;
            margin: 0;
        }
        
        #soundToggle:hover {
            background: rgba(255,255,255,.2);
            transform: translateY(-2px);
        }
        
        .game-history{position:fixed;bottom:20px;right:20px;background:rgba(0,0,0,.8);padding:15px;border-radius:15px;border:1px solid var(--info);display:none;z-index:1000;max-width:300px;max-height:400px;overflow-y:auto;backdrop-filter:blur(10px);}
        .game-history.show{display:block;}
        .referee-info{position:fixed;top:20px;right:20px;background:rgba(0,0,0,.8);padding:15px;border-radius:10px;border:1px solid var(--primary);display:none;z-index:1000;max-width:300px;backdrop-filter:blur(10px);}
        .referee-info.show{display:block;}
        .multiplayer-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);padding:30px;border-radius:20px;border:2px solid var(--info);display:none;z-index:1500;max-width:500px;width:90%;backdrop-filter:blur(20px);}
        .multiplayer-panel.show{display:block;}
        
        /* è°ƒæ•´æ ‡é¢˜ä½ç½®ï¼Œé¿å…ä¸å·¦ä¸Šè§’æŒ‰é’®é‡å  */
        h1 {
            margin-top: 60px !important;
        }
        
        @media(max-width:900px){.game-container{grid-template-columns:1fr;}}
        @media(max-width:768px){
            .card-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;}
            .card{height:150px;}
            h1{font-size:2rem; margin-top: 50px !important;}
            .top-left-controls {
                top: 10px;
                left: 10px;
            }
        }
        @media(max-width:480px){
            body{padding:10px;}
            .card-grid{grid-template-columns:repeat(2,1fr);}
            .panel{padding:15px;}
            h1{font-size:1.8rem; margin-top: 40px !important;}
            .top-left-controls {
                top: 5px;
                left: 5px;
            }
            .help-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }
        
        /* ------------------- å¼€åœºåŠ¨ç”» ------------------- */
        #startOverlay{
            position:fixed;inset:0;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);z-index:3000;
            display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;overflow:hidden;
        }
        @keyframes zoomFadeIn{
            0%   {transform:scale(0.3); opacity:0;}
            50%  {transform:scale(1.1); opacity:1;}
            100% {transform:scale(1);   opacity:1;}
        }
        #startOverlay h1{font-size:3rem;margin:0;animation:zoomFadeIn .8s ease-out forwards;}
        #startOverlay p{margin-top:1rem;font-size:1.2rem;opacity:0;animation:zoomFadeIn .8s ease-out .3s forwards;}
    </style>
</head>

<body>

<!-- ==================== è¯´æ˜ä¹¦ ==================== -->
<div id="manual" class="manual-overlay">
    <div class="manual-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1 style="margin:0;"><i class="fas fa-book"></i> æ¸¸æˆè¯´æ˜ä¹¦</h1>
            <button onclick="closeManual()" style="background:var(--danger);color:white;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:20px;">Ã—</button>
        </div>

        <!-- â˜… ç©æ³•æ¦‚è¿° â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-list-ol"></i> ç©æ³•æ¦‚è¿°</h3>
            <p>ã€Šè°æ˜¯å§åº•ã€‹æ˜¯ä¸€æ¬¾ **4â€‘12 äºº** çš„æ¨ç†ç¤¾äº¤æ¸¸æˆã€‚æ¯å±€æ¸¸æˆä¼šéšæœºæŒ‘é€‰ä¸€ä¸ª"å§åº•è¯"å’Œä¸€ä¸ª"å¹³æ°‘è¯"ï¼Œä»¥åŠè‹¥å¹²"ç™½æ¿"ã€‚ç©å®¶ä»¬åœ¨ä¸æ³„éœ²è‡ªå·±è¯è¯­çš„å‰æä¸‹ï¼Œé€šè¿‡æè¿°ã€æŠ•ç¥¨ã€é—è¨€ç­‰ç¯èŠ‚æ‰¾å‡ºå§åº•ã€‚</p>

            <h4>æ¸¸æˆé˜¶æ®µ</h4>
            <ol style="margin-left:20px;">
                <li><strong>çœ‹ç‰Œé˜¶æ®µï¼ˆViewingï¼‰</strong><br>
                    æ‰€æœ‰ç©å®¶ä¾æ¬¡ç‚¹å‡»è‡ªå·±çš„ç¼–å·å¡ç‰‡æŸ¥çœ‹èº«ä»½è¯ã€‚<br>
                    - å¹³æ°‘ â†’ å¹³æ°‘è¯<br>
                    - å§åº• â†’ å§åº•è¯<br>
                    - ç™½æ¿ â†’ æ— è¯ï¼ˆåªèƒ½é€šè¿‡æè¿°äº†è§£åˆ°è‡ªå·±æ˜¯ç™½æ¿ï¼‰<br>
                    åªæœ‰åœ¨ **å½“å‰è½®åˆ°çš„ç©å®¶** ç¡®è®¤å®Œèº«ä»½åæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é”å®š/è§£é”å¡ç‰‡ã€‚</li>
                <li><strong>æè¿°é˜¶æ®µï¼ˆDescribingï¼‰</strong><br>
                    æŒ‰é¡ºåºæ¯ä½ç©å®¶åœ¨ **è§„å®šæ—¶é—´**ï¼ˆé»˜è®¤ 30â€¯ç§’ï¼‰å†…ï¼Œç”¨è‡ªå·±çš„è¯è¯­è¿›è¡Œæè¿°ï¼Œ**ç¦æ­¢ç›´æ¥è¯´å‡ºè¯è¯­æœ¬èº«**ã€‚<br>
                    æè¿°å¯ä»¥æ˜¯"æˆ‘å¸¸ç”¨å®ƒæ¥â€¦â€¦""å®ƒçš„é¢œè‰²æ˜¯â€¦â€¦"ã€‚<br>
                    è‹¥æ—¶é—´è€—å°½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ **è·³è¿‡** å½“å‰ç©å®¶ï¼ˆå¯é€šè¿‡ "è·³è¿‡æè¿°" æŒ‰é’®æ‰‹åŠ¨è·³è¿‡ï¼‰ã€‚</li>
                <li><strong>æŠ•ç¥¨é˜¶æ®µï¼ˆVotingï¼‰</strong><br>
                    æ‰€æœ‰ç©å®¶ä¾æ®æè¿°è¿›è¡Œè®¨è®ºåï¼Œè¾“å…¥æƒ³è¦æ·˜æ±°çš„ç©å®¶ç¼–å·å¹¶æŠ•ç¥¨ã€‚<br>
                    æŠ•ç¥¨æˆåŠŸåï¼Œç³»ç»Ÿç«‹å³å…¬å¸ƒè¯¥ç©å®¶çš„çœŸå®èº«ä»½ï¼ˆå¹³æ°‘/å§åº•/ç™½æ¿ï¼‰ï¼Œå¹¶æ‰£é™¤ä¸€æ¬¡æŠ•ç¥¨æ¬¡æ•°ï¼ˆ"å¿ƒ"ï¼‰ï¼ŒæŠ•ç¥¨æ¬¡æ•°å¯åœ¨ã€ŒæŠ•ç¥¨æ¬¡æ•°ã€è®¾ç½®ä¸­è‡ªå®šä¹‰ï¼ˆè®¾ä¸º 0 åˆ™ä¸ºæ— é™æŠ•ç¥¨ï¼‰ã€‚</li>
                <li><strong>é—è¨€é˜¶æ®µï¼ˆLast Wordsï¼‰</strong><br>
                    è¢«æ·˜æ±°ç©å®¶åœ¨é™å®šæ—¶é—´ï¼ˆé»˜è®¤ 5â€¯ç§’ï¼‰å†…å‘è¡¨ç®€çŸ­é—è¨€ã€‚é—è¨€ç»“æŸåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€è½®ã€‚</li>
            </ol>

            <h4>æ¸¸æˆç»“æŸæ¡ä»¶ï¼ˆä»»æ„æ»¡è¶³å³ç»“æŸï¼‰</h4>
            <ul style="margin-left:20px;">
                <li>æ‰€æœ‰å§åº•è¢«æŠ•ç¥¨å‡ºå±€ â†’ **å¹³æ°‘èƒœ**ã€‚</li>
                <li>å§åº•æ•°é‡ â‰¥ å¹³æ°‘æ•°é‡ â†’ **å§åº•èƒœ**ã€‚</li>
                <li>æŠ•ç¥¨æ¬¡æ•°ï¼ˆå¿ƒï¼‰è€—å°½ï¼ˆä»…å½“æŠ•ç¥¨æ¬¡æ•°æœ‰é™æ—¶ï¼‰ â†’ **å§åº•èƒœ**ã€‚</li>
                <li>åªå‰©ä¸¤åç©å®¶ä¸”å…¶ä¸­è‡³å°‘æœ‰ä¸€åå§åº• â†’ **å§åº•èƒœ**ã€‚</li>
            </ul>

            <p>æ¸¸æˆç»“æŸåä¼šå¼¹å‡ºæç¤ºï¼Œè®°å½•æœ¬å±€è¯è¯­ã€å›åˆæ•°ä»¥åŠèƒœè´Ÿï¼Œå¹¶å†™å…¥æ—¥å¿—ã€‚ç©å®¶å¯é€šè¿‡ã€Œé‡æ–°å¼€å§‹ã€ç»§ç»­æ–°ä¸€å±€ã€‚</p>
        </div>

        <!-- â˜… è§’è‰²è¯´æ˜ â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-user-tag"></i> è§’è‰²è¯´æ˜</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:10px;">
                <div style="background:linear-gradient(145deg,var(--success),#00b894);padding:15px;border-radius:10px;color:#000;">
                    <h4 style="margin:0 0 8px 0;"><i class="fas fa-user"></i> å¹³æ°‘</h4>
                    <p style="margin:0;font-size:14px;">æŒæœ‰å¹³æ°‘è¯ï¼Œç›®æ ‡æ˜¯é€šè¿‡æè¿°å’ŒæŠ•ç¥¨æ‰¾å‡ºå§åº•ã€‚</p>
                </div>
                <div style="background:linear-gradient(145deg,var(--danger),#d63031);padding:15px;border-radius:10px;color:#fff;">
                    <h4 style="margin:0 0 8px 0;"><i class="fas fa-user-secret"></i> å§åº•</h4>
                    <p style="margin:0;font-size:14px;">æŒæœ‰å§åº•è¯ï¼Œç›®æ ‡æ˜¯éšè—èº«ä»½ï¼Œé¿å…è¢«æŠ•ç¥¨å‡ºå±€ã€‚</p>
                </div>
                <div style="background:linear-gradient(145deg,#a29bfe,#6c5ce7);padding:15px;border-radius:10px;color:#fff;">
                    <h4 style="margin:0 0 8px 0;"><i class="fas fa-user-circle"></i> ç™½æ¿</h4>
                    <p style="margin:0;font-size:14px;">æ— è¯è¯­ï¼Œéœ€è¦é€šè¿‡æè¿°æ¨æ–­è‡ªå·±æ˜¯ç™½æ¿ï¼Œå¹¶å¸®åŠ©å¹³æ°‘æˆ–å§åº•ã€‚</p>
                </div>
            </div>
        </div>

        <!-- â˜… è®¾ç½®è¯´æ˜ â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-cog"></i> è®¾ç½®è¯´æ˜</h3>
            <h4>åŸºæœ¬è®¾ç½®</h4>
            <ul style="margin-left:20px;">
                <li><strong>ç©å®¶äººæ•°</strong>ï¼š4-12äººï¼Œé€šè¿‡æ»‘å—è°ƒæ•´</li>
                <li><strong>éš¾åº¦çº§åˆ«</strong>ï¼š
                    <ul>
                        <li>ç®€å•ï¼š1å§åº•</li>
                        <li>æ™®é€šï¼š1å§åº• + 1ç™½æ¿</li>
                        <li>å›°éš¾ï¼š2å§åº•</li>
                        <li>ä¸“å®¶ï¼š2å§åº• + 1ç™½æ¿</li>
                        <li>è‡ªå®šä¹‰ï¼šæ‰‹åŠ¨è®¾ç½®å§åº•/ç™½æ¿æ•°é‡</li>
                    </ul>
                </li>
                <li><strong>æŠ•ç¥¨æ¬¡æ•°</strong>ï¼šè®¾ç½®æ€»æŠ•ç¥¨æ¬¡æ•°ï¼ˆå¿ƒï¼‰ï¼Œ0è¡¨ç¤ºæ— é™æŠ•ç¥¨</li>
            </ul>

            <h4>æ—¶é—´è®¾ç½®</h4>
            <ul style="margin-left:20px;">
                <li><strong>çœ‹ç‰Œæ—¶é—´</strong>ï¼šæ¯åç©å®¶æŸ¥çœ‹èº«ä»½çš„æ—¶é—´ï¼ˆ2-10ç§’ï¼‰</li>
                <li><strong>æè¿°æ—¶é—´</strong>ï¼šæ¯è½®æè¿°çš„æ—¶é—´é™åˆ¶ï¼ˆ10-60ç§’ï¼‰</li>
                <li><strong>é—è¨€æ—¶é—´</strong>ï¼šè¢«æ·˜æ±°ç©å®¶å‘è¡¨é—è¨€çš„æ—¶é—´ï¼ˆ3-15ç§’ï¼‰</li>
            </ul>

            <h4>è¯è¯­è®¾ç½®</h4>
            <ul style="margin-left:20px;">
                <li><strong>é»˜è®¤è¯åº“</strong>ï¼šä½¿ç”¨å†…ç½®è¯è¯­å¯¹</li>
                <li><strong>è‡ªå®šä¹‰è¯åº“</strong>ï¼šè¾“å…¥è‡ªå·±çš„è¯è¯­å¯¹ï¼ˆæ¯è¡Œä¸€å¯¹ï¼Œç”¨é€—å·åˆ†éš”ï¼‰</li>
                <li><strong>AIç”Ÿæˆ</strong>ï¼šç”±AIéšæœºç”Ÿæˆè¯è¯­å¯¹</li>
                <li><strong>éšæœºåˆ†é…</strong>ï¼šé€‰æ‹©è¯è¯­åˆ†é…ç­–ç•¥ï¼ˆå®Œå…¨éšæœº/å¹³è¡¡åˆ†é…/ç­–ç•¥åˆ†é…ï¼‰</li>
            </ul>
        </div>

        <!-- â˜… é«˜çº§åŠŸèƒ½ â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-magic"></i> é«˜çº§åŠŸèƒ½</h3>
            <h4>æ™ºèƒ½è¾…åŠ©</h4>
            <ul style="margin-left:20px;">
                <li><strong>AIå»ºè®®æè¿°</strong>ï¼šåœ¨æè¿°é˜¶æ®µï¼ŒAIä¼šä¸ºä½ çš„è¯è¯­ç”Ÿæˆåˆé€‚çš„æè¿°å»ºè®®</li>
                <li><strong>è‡ªåŠ¨æè¿°</strong>ï¼šè®©AIè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆå¹¶æäº¤æè¿°</li>
                <li><strong>è¯­éŸ³æç¤º</strong>ï¼šç³»ç»Ÿä¼šç”¨è¯­éŸ³æç¤ºå½“å‰é˜¶æ®µå’Œæ“ä½œ</li>
                <li><strong>è£åˆ¤é¢æ¿</strong>ï¼šæŒ‰ F9 æ˜¾ç¤ºè£åˆ¤ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ‰€æœ‰è§’è‰²åˆ†é…</li>
            </ul>

            <h4>æ¸¸æˆç®¡ç†</h4>
            <ul style="margin-left:20px;">
                <li><strong>ä¿å­˜/åŠ è½½è¿›åº¦</strong>ï¼šå¯éšæ—¶ä¿å­˜æ¸¸æˆçŠ¶æ€ï¼Œç¨åç»§ç»­</li>
                <li><strong>æ¸¸æˆç»Ÿè®¡</strong>ï¼šæŸ¥çœ‹å†å²èƒœç‡ã€å¹³å‡å›åˆæ•°ç­‰æ•°æ®</li>
                <li><strong>æè¿°è®°å½•</strong>ï¼šå¼€å¯åå¯è®°å½•æ‰€æœ‰ç©å®¶çš„æè¿°å†…å®¹</li>
                <li><strong>é¢œè‰²ä¸»é¢˜</strong>ï¼šå¤šç§ä¸»é¢˜å¯ä¾›é€‰æ‹©ï¼Œè‡ªåŠ¨ä¿å­˜åå¥½</li>
            </ul>

            <h4>å¿«æ·é”®</h4>
            <table style="width:100%;border-collapse:collapse;margin-top:10px;background:rgba(0,0,0,.2);border-radius:8px;">
                <tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);"><kbd>ç©ºæ ¼é”®</kbd></td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);">è·³è¿‡æè¿°/ç¡®è®¤çœ‹ç‰Œ</td></tr>
                <tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);"><kbd>å›è½¦é”®</kbd></td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);">ç¡®è®¤æŠ•ç¥¨</td></tr>
                <tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);"><kbd>F9</kbd></td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);">æ˜¾ç¤º/éšè—è£åˆ¤ä¿¡æ¯</td></tr>
                <tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);"><kbd>F10</kbd></td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);">æ˜¾ç¤º/éšè—æ¸¸æˆå†å²</td></tr>
                <tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);"><kbd>F11</kbd></td><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.1);">æ˜¾ç¤ºæ¸¸æˆç»Ÿè®¡</td></tr>
                <tr><td style="padding:8px;"><kbd>ESC</kbd></td><td style="padding:8px;">æš‚åœ/æ¢å¤æ¸¸æˆ</td></tr>
            </table>
        </div>

        <!-- â˜… æ¸¸æˆæŠ€å·§ â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-lightbulb"></i> æ¸¸æˆæŠ€å·§</h3>
            <h4>å¹³æ°‘æŠ€å·§</h4>
            <ul style="margin-left:20px;">
                <li>æè¿°è¦å…·ä½“ä½†ä¸è¦å¤ªæ˜æ˜¾ï¼Œé¿å…å§åº•è½»æ˜“æ¨¡ä»¿</li>
                <li>æ³¨æ„è§‚å¯Ÿå…¶ä»–ç©å®¶çš„æè¿°æ˜¯å¦ä¸ä½ çš„è¯è¯­åŒ¹é…</li>
                <li>ç™½æ¿ç©å®¶é€šå¸¸ä¼šæè¿°å¾—æ¯”è¾ƒæ¨¡ç³Šï¼Œæ³¨æ„åŒºåˆ†</li>
            </ul>

            <h4>å§åº•æŠ€å·§</h4>
            <ul style="margin-left:20px;">
                <li>ä»”ç»†å¬å¹³æ°‘çš„æè¿°ï¼Œæ¨æ–­è‡ªå·±çš„è¯è¯­</li>
                <li>æè¿°è¦ä¸­æ€§ï¼Œæ—¢è¦ä¸å¹³æ°‘ç›¸ä¼¼ï¼Œåˆè¦ç•™æœ‰ä½™åœ°</li>
                <li>å¯ä»¥æ•…æ„æè¿°å¾—ç¨å¾®åç¦»ï¼Œä½†ä¸è¦å¤ªæ˜æ˜¾</li>
            </ul>

            <h4>ç™½æ¿æŠ€å·§</h4>
            <ul style="margin-left:20px;">
                <li>é€šè¿‡ä»–äººçš„æè¿°æ¨æ–­å¯èƒ½çš„è¯è¯­</li>
                <li>æè¿°è¦æ¨¡ç³Šï¼Œè§‚å¯Ÿè°å¯¹ä½ çš„æè¿°ååº”æœ€å¤§</li>
                <li>åæœŸå¯ä»¥é€‰æ‹©å¸®åŠ©å¹³æ°‘æˆ–å§åº•ä¸€æ–¹</li>
            </ul>
        </div>

        <!-- â˜… å¸¸è§é—®é¢˜ â˜… -->
        <div class="manual-section">
            <h3><i class="fas fa-question-circle"></i> å¸¸è§é—®é¢˜</h3>
            <div style="background:rgba(0,0,0,.3);padding:15px;border-radius:10px;margin-top:10px;">
                <p><strong>Q: æ¸¸æˆæ”¯æŒå¤šå°‘äººç©ï¼Ÿ</strong><br>
                A: æ”¯æŒ4-12äººï¼Œå»ºè®®6-8äººæœ€ä½³ã€‚</p>
                
                <p><strong>Q: å¯ä»¥ä¸­é€”é€€å‡ºå—ï¼Ÿ</strong><br>
                A: å¯ä»¥ï¼Œä½¿ç”¨ã€Œä¿å­˜è¿›åº¦ã€åŠŸèƒ½ï¼Œä¸‹æ¬¡å¯åŠ è½½ç»§ç»­ã€‚</p>
                
                <p><strong>Q: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰è¯è¯­ï¼Ÿ</strong><br>
                A: åœ¨è¯è¯­è®¾ç½®ä¸­é€‰æ‹©ã€Œè‡ªå®šä¹‰è¯åº“ã€ï¼Œæ¯è¡Œè¾“å…¥ä¸€å¯¹è¯è¯­ï¼Œç”¨é€—å·åˆ†éš”ã€‚</p>
                
                <p><strong>Q: AIç©å®¶æ€ä¹ˆä½¿ç”¨ï¼Ÿ</strong><br>
                A: åœ¨é«˜çº§è®¾ç½®ä¸­å¯ç”¨AIç©å®¶ï¼ŒAIä¼šè‡ªåŠ¨å‚ä¸æ¸¸æˆã€‚</p>
                
                <p><strong>Q: æ¸¸æˆæœ‰å£°éŸ³å—ï¼Ÿ</strong><br>
                A: æœ‰ï¼Œç‚¹å‡»å·¦ä¸Šè§’å£°éŸ³æŒ‰é’®å¯å¼€å…³éŸ³æ•ˆå’Œè¯­éŸ³ã€‚</p>
            </div>
        </div>

        <div style="text-align:center;margin-top:20px;padding:15px;background:rgba(108,92,231,0.1);border-radius:10px;border:1px solid var(--primary);">
            <p style="margin:0;color:var(--primary);"><i class="fas fa-info-circle"></i> ç¥æ‚¨æ¸¸æˆæ„‰å¿«ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ¸¸æˆå†…çš„æ—¥å¿—å’Œæç¤ºã€‚</p>
        </div>
    </div>
</div>

<!-- ==================== å¼€åœºåŠ¨ç”» ==================== -->
<div id="startOverlay">
    <h1>è°æ˜¯å§åº• - è‰é›¯ç‰ˆ</h1>
    <p>å‡†å¤‡å¥½ğŸ•µï¸â€â™€ï¸ æ¨ç†æ¸¸æˆäº†å—ï¼Ÿ</p>
</div>

<!-- ==================== å·¦ä¸Šè§’æ§åˆ¶æŒ‰é’® ==================== -->
<div class="top-left-controls">
    <!-- å£°éŸ³æ§åˆ¶ -->
    <div class="sound-control">
        <button id="soundToggle" class="btn">
            <i class="fas fa-volume-up"></i> å£°éŸ³å¼€
        </button>
    </div>
    
    <!-- å¸®åŠ©å›¾æ ‡ -->
    <div class="help-icon" id="helpIcon" onclick="showManual()">
        <i class="fas fa-question"></i>
    </div>
</div>

<!-- æ¸¸æˆå†å²é¢æ¿ -->
<div id="gameHistory" class="game-history">
    <h3><i class="fas fa-history"></i> æ¸¸æˆå†å²</h3>
    <div id="historyContent"></div>
</div>

<h1><i class="fas fa-user-secret"></i> è°æ˜¯å§åº• - è‰é›¯ç‰ˆ</h1>

<!-- è£åˆ¤ä¸“ç”¨ä¿¡æ¯ -->
<div id="refereeInfo" class="referee-info">
    <h3><i class="fas fa-eye"></i> è£åˆ¤ä¿¡æ¯</h3>
    <p>å¹³æ°‘è¯: <span id="civilianWord">æœªåˆ†é…</span></p>
    <p>å§åº•è¯: <span id="undercoverWord">æœªåˆ†é…</span></p>
    <p>ç™½æ¿: <span id="blankWord">æœªåˆ†é…</span></p>
    <div class="role-stat">
        <div class="role-item"><div class="role-count" id="refCivilianCount">0</div><div class="role-name">å¹³æ°‘</div></div>
        <div class="role-item"><div class="role-count" id="refUndercoverCount">0</div><div class="role-name">å§åº•</div></div>
        <div class="role-item"><div class="role-count" id="refBlankCount">0</div><div class="role-name">ç™½æ¿</div></div>
    </div>
    <small>æŒ‰ F9 æ˜¾ç¤º/éšè—æ­¤ä¿¡æ¯</small>
</div>

<div class="game-container">
    <div class="panel">
        <h2><i class="fas fa-gavel"></i> æ™ºèƒ½è£åˆ¤</h2>

        <div id="phaseIndicator" class="phase-indicator">æ¸¸æˆæœªå¼€å§‹</div>

        <!-- é—è¨€é˜¶æ®µ -->
        <div id="lastWords" class="last-words">
            <i class="fas fa-microphone-alt"></i> <strong>é—è¨€é˜¶æ®µ</strong>
            <div id="lastWordsText">è¯· <span id="lastWordsPlayer">X</span> å·ç©å®¶å‘è¡¨é—è¨€</div>
            <div class="last-words-timer">å€’è®¡æ—¶: <span id="lastWordsCountdown">5</span>ç§’</div>
            <small>é—è¨€æ—¶é—´ç»“æŸåï¼Œæ¸¸æˆç»§ç»­</small>
        </div>

        <!-- æè¿°è®°å½• -->
        <div id="descriptionHistory" class="description-history" style="display:none;">
            <h4><i class="fas fa-comments"></i> æè¿°è®°å½•</h4>
            <div id="descriptionList"></div>
        </div>

        <div id="setup">
            <!-- åŸºæœ¬è®¾ç½® -->
            <div class="setting-group">
                <div class="setting-title"><i class="fas fa-users"></i> åŸºæœ¬è®¾ç½®</div>
                <label>ç©å®¶äººæ•°:</label>
                <input type="range" id="pNum" min="4" max="12" value="6" oninput="updatePlayerCount(this.value)">
                <div style="text-align:center;margin:5px 0;font-size:18px;color:var(--primary);" id="playerCountDisplay">6 äºº</div>

                <label>éš¾åº¦çº§åˆ«:</label>
                <select id="difficulty">
                    <option value="easy">ç®€å• (1å§åº•)</option>
                    <option value="normal" selected>æ™®é€š (1å§åº•+1ç™½æ¿)</option>
                    <option value="hard">å›°éš¾ (2å§åº•)</option>
                    <option value="expert">ä¸“å®¶ (2å§åº•+1ç™½æ¿)</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>

                <div id="customDifficulty" style="display:none;">
                    <label>å§åº•æ•°é‡:</label>
                    <input type="number" id="customUndercover" min="1" max="3" value="1">
                    <label>ç™½æ¿æ•°é‡:</label>
                    <input type="number" id="customBlank" min="0" max="2" value="1">
                </div>

                <!-- â˜… æŠ•ç¥¨æ¬¡æ•°è‡ªå®šä¹‰ â˜… -->
                <div class="setting-title"><i class="fas fa-heart"></i> æŠ•ç¥¨æ¬¡æ•°è®¾ç½®</div>
                <label>æŠ•ç¥¨æ¬¡æ•° (å¿ƒ):</label>
                <input type="number" id="voteCount" min="0" max="20" value="3">
                <small style="color:#aaa;font-size:12px;">
                    0 è¡¨ç¤ºæ— é™æŠ•ç¥¨ï¼ˆä»…è°ƒè¯•æˆ–ç‰¹æ®Šç©æ³•ï¼‰ï¼Œé»˜è®¤å€¼ä¸ºç©å®¶äººæ•°/2 å‘ä¸Šå–æ•´
                </small>
            </div>

            <!-- æ—¶é—´è®¾ç½® -->
            <div class="setting-group">
                <div class="setting-title"><i class="fas fa-clock"></i> æ—¶é—´è®¾ç½®</div>
                <label>çœ‹ç‰Œæ—¶é—´ (ç§’):</label>
                <input type="number" id="viewTime" min="2" max="10" value="3">
                <label>é—è¨€æ—¶é—´ (ç§’):</label>
                <input type="number" id="lastWordsTime" min="3" max="15" value="5">
                <label>æè¿°æ—¶é—´ (ç§’):</label>
                <input type="number" id="describeTime" min="10" max="60" value="30">
                <small style="color:#aaa;font-size:12px;">æè¿°æ—¶é—´èŒƒå›´ï¼š10â€‘60 ç§’</small>
            </div>

            <!-- è¯è¯­è®¾ç½® -->
            <div class="setting-group">
                <div class="setting-title"><i class="fas fa-font"></i> è¯è¯­è®¾ç½®</div>
                <label>è¯è¯­æ¥æº:</label>
                <select id="wordSource" onchange="toggleWordSource()">
                    <option value="default" selected>é»˜è®¤è¯åº“</option>
                    <option value="custom">è‡ªå®šä¹‰è¯åº“</option>
                    <option value="ai">AIç”Ÿæˆ</option>
                </select>

                <div id="customWordsSection" style="display:none;">
                    <label>è‡ªå®šä¹‰è¯è¯­ (æ¯è¡Œä¸€å¯¹, ç”¨é€—å·åˆ†éš”):</label>
                    <textarea id="customWords" class="custom-words-input"
                              placeholder="å¾®ä¿¡,æ”¯ä»˜å®&#10;æ‰‹æœº,ç”µè„‘&#10;è‹¹æœ,é¦™è•‰&#10;å¤–å–,å¿«é€’"></textarea>
                </div>

                <label>éšæœºåˆ†é…:</label>
                <select id="wordRandomness">
                    <option value="shuffle">å®Œå…¨éšæœº</option>
                    <option value="balanced">å¹³è¡¡åˆ†é…</option>
                    <option value="strategic">ç­–ç•¥åˆ†é…</option>
                </select>
            </div>

            <!-- â˜… é¢œè‰²ä¸»é¢˜ â˜… -->
            <div class="setting-group">
                <div class="setting-title"><i class="fas fa-palette"></i> è‰²å½©ä¸»é¢˜</div>
                <label>é€‰æ‹©ä¸»é¢˜:</label>
                <select id="colorTheme" onchange="applyTheme(this.value)">
                    <option value="æ·±è“" selected>é»˜è®¤ï¼ˆæ·±è“ï¼‰</option>
                    <option value="æµ·æ´‹">æµ·æ´‹ï¼ˆè“ç»¿ï¼‰</option>
                    <option value="æš®è‰²">æš®è‰²ï¼ˆæ©™ç´«ï¼‰</option>
                    <option value="æ£®æ—">æ£®æ—ï¼ˆç»¿æ£•ï¼‰</option>
                </select>
                <small style="color:#aaa;font-size:12px;">åˆ‡æ¢åç«‹å³ç”Ÿæ•ˆï¼Œä¸»é¢˜ä¼šè¢«ä¿å­˜ã€‚</small>
            </div>

            <button class="btn btn-main" onclick="init()"><i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ</button>

            <div style="display:flex;gap:10px;margin-top:10px;">
                <button class="btn btn-info" onclick="toggleAdvancedSettings()" style="flex:1;">
                    <i class="fas fa-cog"></i> é«˜çº§è®¾ç½®
                </button>
                <button class="btn" onclick="showManual()" style="flex:1;background:#555;">
                    <i class="fas fa-book"></i> è¯´æ˜ä¹¦
                </button>
            </div>

            <!-- é«˜çº§è®¾ç½® -->
            <div id="advancedSettings" class="advanced-settings">
                <div class="setting-group">
                    <div class="setting-title"><i class="fas fa-gamepad"></i> æ¸¸æˆè§„åˆ™</div>
                    <label><input type="checkbox" id="allowRevote" checked> å…è®¸é‡æ–°æŠ•ç¥¨</label>
                    <label><input type="checkbox" id="autoSkipDescribe"> è‡ªåŠ¨è·³è¿‡æè¿°</label>
                    <label><input type="checkbox" id="showRoleStats" checked> æ˜¾ç¤ºè§’è‰²ç»Ÿè®¡</label>
                    <label><input type="checkbox" id="recordDescriptions"> è®°å½•æè¿°å†…å®¹</label>
                    <label><input type="checkbox" id="enableAI"> å¯ç”¨AIç©å®¶</label>
                </div>

                <div class="setting-group">
                    <div class="setting-title"><i class="fas fa-chart-bar"></i> æ¸¸æˆåŠŸèƒ½</div>
                    <button class="btn" style="background:#555;width:100%;" onclick="showGameStats()">
                        <i class="fas fa-chart-pie"></i> æŸ¥çœ‹æ¸¸æˆç»Ÿè®¡
                    </button>
                    <button class="btn" style="background:var(--danger);width:100%;margin-top:5px;" onclick="clearGameStats()">
                        <i class="fas fa-eraser"></i> æ¸…é›¶ç»Ÿè®¡è®°å½•
                    </button>
                </div>

                <div class="setting-group">
                    <div class="setting-title"><i class="fas fa-save"></i> æ¸¸æˆä¿å­˜</div>
                    <div style="display:flex;gap:10px;">
                        <button class="btn" style="background:#444;flex:1;" onclick="saveGameState()">
                            <i class="fas fa-save"></i> ä¿å­˜è¿›åº¦
                        </button>
                        <button class="btn" style="background:#333;flex:1;" onclick="loadGameState()">
                            <i class="fas fa-folder-open"></i> åŠ è½½è¿›åº¦
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆ UIï¼ˆè¿›è¡Œæ—¶ï¼‰ -->
        <div id="gameUI" style="display:none">
            <div class="timer" id="timer">
                <i class="fas fa-clock"></i> å‰©ä½™çœ‹ç‰Œæ—¶é—´: <span id="timeLeft">3</span>ç§’
            </div>

            <div class="stats">
                <div class="stat-item"><div class="stat-value"><i class="fas fa-heart"></i> <span id="hearts">3</span></div><div class="stat-label">å‰©ä½™æŠ•ç¥¨æ¬¡æ•°</div></div>
                <div class="stat-item"><div class="stat-value" id="aliveCount">6</div><div class="stat-label">å­˜æ´»ç©å®¶</div></div>
                <div class="stat-item"><div class="stat-value" id="viewedCount">0</div><div class="stat-label">å·²çœ‹ç‰Œ</div></div>
            </div>

            <!-- è§’è‰²ç»Ÿè®¡ï¼ˆå— showRoleStats æ§åˆ¶ï¼‰ -->
            <div id="roleStats" class="role-stat" style="display:none;">
                <div class="role-item"><div class="role-count" id="civilianCount">0</div><div class="role-name">å¹³æ°‘</div></div>
                <div class="role-item"><div class="role-count" id="undercoverCount">0</div><div class="role-name">å§åº•</div></div>
                <div class="role-item"><div class="role-count" id="blankCount">0</div><div class="role-name">ç™½æ¿</div></div>
            </div>

            <p id="guideText">è¯·ç‚¹å‡»æ‚¨çš„ç¼–å·å¡ç‰‡æŸ¥çœ‹èº«ä»½è¯</p>

            <!-- æè¿°é˜¶æ®µæŒ‰é’® -->
            <button class="btn btn-warning" id="startDescribeBtn" onclick="startDescribeRound()" style="display:none;">
                <i class="fas fa-microphone"></i> å¼€å§‹æè¿°ç¯èŠ‚
            </button>

            <div id="voteSection" style="display:none;">
                <p id="describePrompt" style="margin-bottom:10px;">è¯· å‘è¨€æè¿°ä½ çš„è¯è¯­</p>

                <!-- æè¿°è¾“å…¥æ¡†ï¼ˆrecordDescriptions æ§åˆ¶æ˜¾ç¤ºï¼‰ -->
                <div id="descriptionInput" style="display:none;margin-bottom:10px;">
                    <input type="text" id="descriptionText" placeholder="è¾“å…¥ä½ çš„æè¿°ï¼ˆå¯é€‰ï¼‰">
                    <div style="display:flex;gap:10px;margin-top:5px;">
                        <button class="btn" onclick="submitDescription()" style="background:#666;flex:1;">
                            <i class="fas fa-paper-plane"></i> æäº¤æè¿°
                        </button>
                        <button class="btn" onclick="generateAIDescription()" style="background:#777;flex:1;">
                            <i class="fas fa-robot"></i> AIå»ºè®®
                        </button>
                    </div>
                </div>

                <div style="display:flex;gap:10px;">
                    <input type="number" id="voteId" placeholder="æŠ•ç¥¨å‡ºå±€ç¼–å·" min="1">
                    <button class="btn btn-vote" id="voteBtn" onclick="vote()">
                        <i class="fas fa-vote-yea"></i> æŠ•ç¥¨
                    </button>
                </div>

                <div style="display:flex;gap:10px;margin-top:10px;">
                    <button class="btn" id="skipDescribeBtn" onclick="skipDescribe()" style="background:#555;flex:1;">
                        <i class="fas fa-forward"></i> è·³è¿‡æè¿°
                    </button>
                    <button class="btn" id="autoDescribeBtn" onclick="autoDescribe()" style="background:#777;flex:1;">
                        <i class="fas fa-robot"></i> è‡ªåŠ¨æè¿°
                    </button>
                </div>
            </div>

            <div style="margin-top:20px;display:flex;gap:10px;">
                <button class="btn" style="background:#333;color:#aaa;flex:1;" onclick="location.reload()">
                    <i class="fas fa-redo"></i> é‡æ–°å¼€å§‹
                </button>
                <button class="btn" style="background:#444;color:#aaa;flex:1;" onclick="pauseGame()">
                    <i class="fas fa-pause"></i> æš‚åœ
                </button>
                <button class="btn" style="background:#555;color:#aaa;flex:1;" onclick="saveGameState()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>

        <h3 style="margin-top:20px;"><i class="fas fa-scroll"></i> æ¸¸æˆæ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <div class="card-grid" id="grid"></div>
</div>

<script>
/* ======================== 1ï¸âƒ£ çŠ¶æ€ & å¸¸é‡ ======================== */
const state = {
    players: [], chances: 3, viewing: false, viewCount: 0,
    gamePhase: 'setup', timer: null, currentViewer: null,
    nextViewer: 1,
    currentRound: 1, currentDescriber: 1, descriptionComplete: false,
    words: [], lastWordsTimer: null, descriptions: [], gameActions: [], isReplaying: false,
    descriptionTimer: null,

    gameStats: { totalGames:0, civilianWins:0, undercoverWins:0, averageRounds:0, history:[] },

    settings: {
        soundEnabled:true, musicEnabled:false,
        viewTime:3, lastWordsTime:5, describeTime:30,
        voteCount:null,
        allowRevote:true, autoSkipDescribe:false, showRoleStats:true,
        recordDescriptions:false, enableAI:false, aiPlayers:[]
    },

    multiplayer:{ enabled:false, roomId:null, players:[], socket:null }
};

/* ======================== 2ï¸âƒ£ è¯åº“ & AI ======================== */
const ENHANCED_DEFAULT_WORDS = [
    ["å¾®ä¿¡","æ”¯ä»˜å®"],["æ‰‹æœº","ç”µè„‘"],["è‹¹æœ","é¦™è•‰"],["å¤–å–","å¿«é€’"],
    ["å’–å•¡","èŒ¶"],["ç”µå½±","ç”µè§†å‰§"],["å¤å¤©","å†¬å¤©"],["ç¯®çƒ","è¶³çƒ"],
    ["å¾®åš","æŠ–éŸ³"],["ç«è½¦","é£æœº"],["é¢åŒ…","è›‹ç³•"],["å•¤é…’","çº¢é…’"],
    ["è·‘æ­¥","æ¸¸æ³³"],["é’¢ç´","å‰ä»–"],["æµ·æ´‹","æ¹–æ³Š"],["æ²™æ¼ ","è‰åŸ"],
    ["é—ªç”µ","é›·é¸£"],["è´è¶","èœœèœ‚"],["å›¾ä¹¦é¦†","ä¹¦åº—"],["åŒ»ç”Ÿ","æŠ¤å£«"],
    ["è€å¸ˆ","å­¦ç”Ÿ"],["è­¦å¯Ÿ","ä¿å®‰"],["çŒ«","ç‹—"],["å¤ªé˜³","æœˆäº®"],
    ["æ˜Ÿæ˜Ÿ","æ˜Ÿåº§"],["é›¨ä¼","é›¨è¡£"],["å†°ç®±","ç©ºè°ƒ"],["å¾®æ³¢ç‚‰","çƒ¤ç®±"]
];
const AI_DESCRIPTORS = {
    'å¾®ä¿¡':['ç¤¾äº¤è½¯ä»¶','å¯ä»¥å‘æœ‹å‹åœˆ','ç»¿è‰²å›¾æ ‡','å³æ—¶é€šè®¯','æœ‰æ”¯ä»˜åŠŸèƒ½'],
    'æ”¯ä»˜å®':['æ”¯ä»˜å·¥å…·','æ‰«ç ä»˜æ¬¾','è“è‰²å›¾æ ‡','é‡‘èåº”ç”¨','æœ‰ä½™é¢å®'],
    'æ‰‹æœº':['é€šè®¯å·¥å…·','å¯ä»¥ä¸Šç½‘','ä¾¿æºè®¾å¤‡','æ™ºèƒ½ç»ˆç«¯','æœ‰æ‘„åƒå¤´'],
    'ç”µè„‘':['ç”µå­äº§å“','ç”¨äºåŠå…¬','æœ‰æ˜¾ç¤ºå±','è®¡ç®—è®¾å¤‡','æœ‰é”®ç›˜é¼ æ ‡'],
    'è‹¹æœ':['ä¸€ç§æ°´æœ','çº¢è‰²æˆ–ç»¿è‰²','æœ‰æ ¸','å¸¸è§æ°´æœ','å¯æ¦¨æ±'],
    'é¦™è•‰':['é»„è‰²æ°´æœ','å¼¯æ›²å½¢çŠ¶','çƒ­å¸¦æ°´æœ','æœ‰çš®','è½¯ç³¯é¦™ç”œ']
};

/* ==================== 3ï¸âƒ£ éŸ³æ•ˆ & è¯­éŸ³ ==================== */
class SoundManager{
    constructor(){ this.audioContext=null; this.init(); }
    init(){
        try{ this.audioContext=new (window.AudioContext||window.webkitAudioContext)(); }
        catch(e){ console.log('Web Audio API æœªå¯ç”¨'); }
    }
    playTone(freq,dur=.3,type='sine'){
        if(!state.settings.soundEnabled||!this.audioContext) return;
        try{
            const osc=this.audioContext.createOscillator();
            const gain=this.audioContext.createGain();
            osc.connect(gain); gain.connect(this.audioContext.destination);
            osc.frequency.setValueAtTime(freq,this.audioContext.currentTime);
            osc.type=type;
            gain.gain.setValueAtTime(.3,this.audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+dur);
            osc.start(this.audioContext.currentTime);
            osc.stop(this.audioContext.currentTime+dur);
        }catch(e){ console.log('éŸ³æ•ˆæ’­æ”¾é”™è¯¯'); }
    }
    playSound(type){
        switch(type){
            case 'flip':   this.playTone(523.25,.3); setTimeout(()=>this.playTone(659.25,.3),100); break;
            case 'success':this.playTone(783.99,.3); setTimeout(()=>this.playTone(1046.5,.4),100); break;
            case 'danger': this.playTone(392,.3); setTimeout(()=>this.playTone(311.13,.4),100); break;
            case 'warning':this.playTone(440,.3); setTimeout(()=>this.playTone(349.23,.4),100); break;
            case 'info':   this.playTone(659.25,.3); setTimeout(()=>this.playTone(523.25,.3),100); break;
            case 'vote':  this.playTone(261.63,.2); setTimeout(()=>this.playTone(329.63,.2),50); setTimeout(()=>this.playTone(392,.3),100); break;
        }
    }
}
const soundManager = new SoundManager();
function speak(txt){
    if(!state.settings.soundEnabled||!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const utter=new SpeechSynthesisUtterance(txt);
    utter.lang='zh-CN'; utter.rate=1; utter.pitch=1;
    const voices=speechSynthesis.getVoices();
    const zh=voices.find(v=>v.lang.startsWith('zh'));
    if(zh) utter.voice=zh;
    window.speechSynthesis.speak(utter);
}

/* ==================== 4ï¸âƒ£ å·¥å…·å‡½æ•° ==================== */
function debounce(fn,wait){ let t; return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}; }
function throttle(fn,limit){ let inThrottle; return (...a)=>{if(!inThrottle){fn(...a);inThrottle=setTimeout(()=>inThrottle=0,limit);} }}

/* ==================== 5ï¸âƒ£ ä¸»é¢˜ç³»ç»Ÿ ==================== */
/**
 * ä¸»é¢˜åˆ—è¡¨ï¼ˆå·²ç§»é™¤ â€œæŸ”å…‰â€ ä¸»é¢˜ï¼‰
 * å¦‚éœ€æ·»åŠ æ–°ä¸»é¢˜ï¼Œåªéœ€åœ¨æ­¤å¯¹è±¡ä¸­æ·»åŠ å¯¹åº”çš„é”®å€¼å¯¹å³å¯ã€‚
 */
const THEMES = {
    æ·±è“: {'--primary':'#6c5ce7','--danger':'#ff7675','--success':'#55efc4','--warning':'#fdcb6e','--info':'#74b9ff','--bg':'#0f0c29','--text':'#fff'},
    æµ·æ´‹: {'--primary':'#0984e3','--danger':'#d63031','--success':'#00b894','--warning':'#fdcb6e','--info':'#74b9ff','--bg':'#0c2461','--text':'#e0f7fa'},
    æš®è‰²: {'--primary':'#e84393','--danger':'#d63031','--success':'#ffeaa7','--warning':'#fdcb6e','--info':'#00b894','--bg':'#2d3436','--text':'#fff'},
    æ£®æ—: {'--primary':'#00b894','--danger':'#ff7675','--success':'#55efc4','--warning':'#fdcb6e','--info':'#74b9ff','--bg':'#2d3436','--text':'#dff9fb'}
};
function loadSavedTheme(){
    // è‹¥æœ¬åœ°æ›¾ä¿å­˜çš„ä¸»é¢˜æ˜¯å·²åˆ é™¤çš„ â€œæŸ”å…‰â€ï¼Œå›é€€åˆ°é»˜è®¤ä¸»é¢˜
    const saved = localStorage.getItem('selectedTheme');
    const name = saved && THEMES[saved] ? saved : 'æ·±è“';
    applyTheme(name,false);
}
function applyTheme(name,save=true){
    const theme=THEMES[name];
    if(!theme) return;
    const root=document.documentElement;
    Object.entries(theme).forEach(([k,v])=>root.style.setProperty(k,v));
    if(save){
        // åªä¿å­˜å·²å­˜åœ¨çš„ä¸»é¢˜åç§°
        if(THEMES[name]) localStorage.setItem('selectedTheme',name);
        recordGameAction('theme_change',{theme:name});
        addLog(`å·²åˆ‡æ¢ä¸»é¢˜ä¸º ${name}`,'info');
        speak(`å·²åˆ‡æ¢ä¸º${name}ä¸»é¢˜`);
    }
}
loadSavedTheme();

/* ==================== 6ï¸âƒ£ UI äº¤äº’ ==================== */
function updatePlayerCount(v){ document.getElementById('playerCountDisplay').textContent=`${v} äºº`; }
function toggleWordSource(){
    const src=document.getElementById('wordSource').value;
    document.getElementById('customWordsSection').style.display = src==='custom' ? 'block':'none';
}
function toggleAdvancedSettings(){ document.getElementById('advancedSettings').classList.toggle('expanded'); }
document.getElementById('difficulty').addEventListener('change',function(){
    document.getElementById('customDifficulty').style.display = this.value==='custom' ? 'block':'none';
});

/* ==================== 7ï¸âƒ£ æœ¬åœ°ç»Ÿè®¡ ==================== */
function loadGameStats(){
    const s=localStorage.getItem('undercoverGameStats');
    if(s) state.gameStats=JSON.parse(s);
}
function saveGameStats(){ localStorage.setItem('undercoverGameStats',JSON.stringify(state.gameStats)); }
loadGameStats();

/* ==================== 8ï¸âƒ£ ä¿å­˜ / åŠ è½½ ==================== */
function saveGameState(){
    const data={
        players:state.players,chances:state.chances,viewing:state.viewing,
        viewCount:state.viewCount,gamePhase:state.gamePhase,
        currentViewer:state.currentViewer,currentRound:state.currentRound,
        currentDescriber:state.currentDescriber,descriptionComplete:state.descriptionComplete,
        words:state.words,descriptions:state.descriptions,
        gameActions:state.gameActions,timestamp:Date.now()
    };
    localStorage.setItem('undercoverGameState',JSON.stringify(data));
    addLog('æ¸¸æˆè¿›åº¦å·²ä¿å­˜','success'); speak('æ¸¸æˆè¿›åº¦å·²ä¿å­˜');
    recordGameAction('save_game',{timestamp:Date.now()});
}
function loadGameState(){
    const raw=localStorage.getItem('undercoverGameState');
    if(!raw){ alert('æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„æ¸¸æˆè¿›åº¦'); return; }
    if(!confirm('æ£€æµ‹åˆ°æœªå®Œæˆçš„æ¸¸æˆè¿›åº¦ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ')) return;
    try{
        const d=JSON.parse(raw);
        Object.assign(state,d);
        if(state.words.length>=2){
            document.getElementById('civilianWord').textContent=state.words[0];
            document.getElementById('undercoverWord').textContent=state.words[1];
            document.getElementById('blankWord').textContent='ç™½æ¿';
        }
        document.getElementById('setup').style.display='none';
        document.getElementById('gameUI').style.display='block';
        if(state.settings.recordDescriptions){
            document.getElementById('descriptionHistory').style.display='block';
            document.getElementById('descriptionInput').style.display='block';
        }
        render(); updateStats(); updatePhaseIndicator(); updateRoleStats();
        addLog('æ¸¸æˆè¿›åº¦å·²åŠ è½½','success'); speak('æ¸¸æˆè¿›åº¦å·²åŠ è½½');
        recordGameAction('load_game',{timestamp:Date.now()});
    }catch(e){ console.error(e); alert('åŠ è½½å¤±è´¥ï¼Œæ•°æ®å¯èƒ½å·²æŸå'); }
}

/* ==================== 9ï¸âƒ£ æ—¥å¿— & ç»Ÿè®¡ ==================== */
function addLog(txt,type='info'){
    const l=document.getElementById('log');
    const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const col=type==='danger'? 'var(--danger)':
              type==='success'? 'var(--success)':
              type==='warning'? 'var(--warning)':
              type==='info'?    'var(--info)':'var(--primary)';
    l.innerHTML=`<div style="border-left:3px solid ${col};padding-left:10px;">
                    <span style="color:#777">[${time}]</span> ${txt}
                 </div>`+l.innerHTML;
    const logs=l.querySelectorAll('div');
    if(logs.length>20) logs[logs.length-1].remove();
    if(!state.isReplaying) recordGameAction('log',{text:txt,type});
}
function addHistory(txt){
    const h=document.getElementById('historyContent');
    const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    h.innerHTML=`<div class="game-history-item">[${time}] ${txt}</div>`+h.innerHTML;
    const items=h.querySelectorAll('.game-history-item');
    if(items.length>10) items[items.length-1].remove();
}

/* ==================== 10ï¸âƒ£ è§’è‰²ç»Ÿè®¡ ==================== */
function updateRoleStats(){
    if(!state.settings.showRoleStats) return;
    const alive=state.players.filter(p=>p.alive);
    const civ=alive.filter(p=>p.type==='civilian').length;
    const und=alive.filter(p=>p.type==='undercover').length;
    const blk=alive.filter(p=>p.type==='blank').length;
    document.getElementById('civilianCount').textContent=civ;
    document.getElementById('undercoverCount').textContent=und;
    document.getElementById('blankCount').textContent=blk;
    document.getElementById('refCivilianCount').textContent=civ;
    document.getElementById('refUndercoverCount').textContent=und;
    document.getElementById('refBlankCount').textContent=blk;
    document.getElementById('roleStats').style.display='flex';
}

/* ==================== 11ï¸âƒ£ é˜¶æ®µæŒ‡ç¤º ==================== */
function updatePhaseIndicator(){
    const el=document.getElementById('phaseIndicator');
    const map={setup:'æ¸¸æˆè®¾ç½®',viewing:'çœ‹ç‰Œé˜¶æ®µ',describing:'æè¿°é˜¶æ®µ',
               voting:'æŠ•ç¥¨é˜¶æ®µ',lastwords:'é—è¨€é˜¶æ®µ',ended:'æ¸¸æˆç»“æŸ',paused:'æ¸¸æˆæš‚åœ'};
    el.textContent=`å½“å‰é˜¶æ®µ: ${map[state.gamePhase]} - ç¬¬${state.currentRound}è½®`;
    const colors={viewing:'rgba(108,92,231,.2)',describing:'rgba(253,203,110,.2)',
                  voting:'rgba(255,118,117,.2)',lastwords:'rgba(253,203,110,.2)',paused:'rgba(149,165,166,.2)'};
    el.style.background=colors[state.gamePhase]||'rgba(108,92,231,.2)';
    el.style.borderColor = (state.gamePhase==='paused')?'#95a5a6':'var(--primary)';
}

/* ==================== 12ï¸âƒ£ æ¸²æŸ“å¡ç‰‡ ==================== */
function render(){
    const fn=()=>{
        const grid=document.getElementById('grid');
        grid.innerHTML=state.players.map(p=>{
            const backCls=p.type;
            const roleName=p.type==='civilian'?'å¹³æ°‘':p.type==='undercover'?'å§åº•':'ç™½æ¿';
            const badge = (p.id===state.nextViewer && state.gamePhase==='viewing')
                         ? '<div style="position:absolute;top:4px;right:4px;background:var(--primary);color:#fff;padding:2px 5px;border-radius:4px;font-size:12px;">â–¶</div>'
                         : '';
            return `<div class="card ${p.viewed?'viewed':''} ${!p.alive?'out':''}"
                        id="c-${p.id}" onclick="flip(${p.id})">
                        <div class="card-inner">
                            <div class="front">${p.id}${badge}</div>
                            <div class="back ${backCls}">
                                <small>${roleName}</small>
                                <h3>${p.w}</h3>
                                ${p.type==='blank'?'<p style="font-size:12px;margin-top:5px;">(æ— è¯è¯­)</p>':''}
                            </div>
                        </div>
                    </div>`;
        }).join('');
    };
    if('requestIdleCallback' in window) requestIdleCallback(fn);
    else setTimeout(fn,0);
}

/* ==================== 13ï¸âƒ£ è®¡æ•°å™¨ ==================== */
function updateStats(){
    const alive=state.players.filter(p=>p.alive).length;
    const viewed=state.players.filter(p=>p.viewed).length;
    document.getElementById('aliveCount').textContent=alive;
    document.getElementById('viewedCount').textContent=viewed;
    document.getElementById('hearts').textContent=state.chances;
}

/* ==================== 14ï¸âƒ£ çœ‹ç‰Œï¼ˆç¿»å¡ï¼‰ ==================== */
function flip(id){
    if(state.gamePhase!=='viewing') return;

    // å¿…é¡»æŒ‰é¡ºåºè§‚çœ‹
    if(id!==state.nextViewer){
        const hint = `è¯·å…ˆè®© ${state.nextViewer} å·ç©å®¶æŸ¥çœ‹èº«ä»½`;
        addLog(hint,'warning'); speak(hint);
        return;
    }

    const p = state.players.find(pl=>pl.id===id);
    if(!p || !p.alive || p.viewed){ speak('è¯¥ç©å®¶å·²ç¡®è®¤èº«ä»½æˆ–å·²å‡ºå±€'); return; }

    const card=document.getElementById(`c-${id}`);
    card.classList.add('flipped');
    state.viewing=true; state.currentViewer=id;
    soundManager.playSound('flip');
    // é”ä½å…¶ä½™å¡ç‰‡
    document.querySelectorAll('.card').forEach(c=>{if(c.id!=='c-'+id) c.classList.add('locked');});

    const start=performance.now();
    const dur=state.settings.viewTime*1000;
    const timerEl=document.getElementById('timer');
    const leftEl=document.getElementById('timeLeft');
    timerEl.style.display='block';

    function step(now){
        const elapsed=now-start;
        const left=Math.max(Math.ceil((dur-elapsed)/1000),0);
        leftEl.textContent=left;
        if(elapsed<dur) requestAnimationFrame(step);
        else{
            // å®Œæˆå½“å‰ç©å®¶çš„çœ‹ç‰Œ
            card.classList.remove('flipped');
            card.classList.add('viewed');
            p.viewed=true;
            state.viewCount++;
            state.viewing=false; state.currentViewer=null;
            // è§£é”å…¨éƒ¨å¡ç‰‡ååªé”å®šä¸‹ä¸€ä¸ªæœªçœ‹ç©å®¶
            document.querySelectorAll('.card').forEach(c=>c.classList.remove('locked'));

            const aliveUnviewed = state.players.filter(pl=>pl.alive && !pl.viewed);
            if(aliveUnviewed.length){
                state.nextViewer = Math.min(...aliveUnviewed.map(pl=>pl.id));
                document.querySelectorAll('.card').forEach(c=>{
                    const cid = Number(c.id.split('-')[1]);
                    if(cid!==state.nextViewer) c.classList.add('locked');
                });
                addLog(`è¯· ${state.nextViewer} å·ç©å®¶æŸ¥çœ‹èº«ä»½`,'info');
                speak(`è¯· ${state.nextViewer} å·ç©å®¶æŸ¥çœ‹èº«ä»½`);
            }else{
                // æ‰€æœ‰ç©å®¶å·²çœ‹å®Œ â†’ è¿›å…¥æè¿°é˜¶æ®µ
                state.gamePhase='describing';
                updatePhaseIndicator();
                document.getElementById('startDescribeBtn').style.display='block';
                document.getElementById('guideText').innerText='å…¨å‘˜èº«ä»½ç¡®è®¤å®Œæˆï¼Œè¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æè¿°ç¯èŠ‚';
                speak('å…¨å‘˜èº«ä»½å·²ç¡®è®¤ï¼Œå‡†å¤‡è¿›å…¥æè¿°ç¯èŠ‚ã€‚');
                recordGameAction('phase_change',{from:'viewing',to:'describing'});
                document.querySelectorAll('.card').forEach(c=>c.classList.remove('locked'));
            }
            addLog(`${id}å·ç©å®¶ç¡®è®¤èº«ä»½å®Œæˆ`,'success');
            updateStats(); updateRoleStats();
            recordGameAction('view_card',{playerId:id,role:p.type});
        }
    }
    requestAnimationFrame(step);
}

/* ==================== 15ï¸âƒ£ æè¿°ç¯èŠ‚ ==================== */
function startDescribeRound(){
    if(state.gamePhase!=='describing') return;
    state.gamePhase='describing';
    updatePhaseIndicator();
    const alive=state.players.filter(p=>p.alive);
    state.currentDescriber=alive.length?alive[0].id:0;

    document.getElementById('startDescribeBtn').style.display='none';
    document.getElementById('voteSection').style.display='block';
    document.getElementById('descriptionInput').style.display=state.settings.recordDescriptions?'block':'none';
    document.getElementById('skipDescribeBtn').style.display='inline-block';
    document.getElementById('autoDescribeBtn').style.display='inline-block';
    document.getElementById('voteId').style.display='none';
    document.getElementById('voteBtn').style.display='none';

    document.getElementById('guideText').innerText=`ç¬¬${state.currentRound}è½®æè¿°å¼€å§‹`;
    updateDescribePrompt();
    render();
    recordGameAction('round_start',{round:state.currentRound});
    speak(`ç¬¬${state.currentRound}è½®æè¿°å¼€å§‹ï¼Œè¯·${state.currentDescriber}å·ç©å®¶å‘è¨€ã€‚`);
    startDescriptionTimeout();
}
function updateDescribePrompt(){ document.getElementById('describePrompt').innerText=`è¯· ${state.currentDescriber} å·ç©å®¶æè¿°ä½ çš„è¯è¯­`; }

/* æè¿°å€’è®¡æ—¶ï¼ˆè¶…æ—¶è‡ªåŠ¨è·³è¿‡ï¼‰ */
function startDescriptionTimeout(){
    if(state.settings.describeTime===0) return;
    const container=document.getElementById('voteSection');
    const timerDiv=document.createElement('div');
    timerDiv.id='describeTimeLeft';
    timerDiv.style.cssText='text-align:center;font-size:16px;color:var(--warning);margin:10px 0;padding:10px;background:rgba(0,0,0,.3);border-radius:5px;';
    container.insertBefore(timerDiv,container.firstChild);
    let left=state.settings.describeTime;
    timerDiv.innerHTML=`<i class="fas fa-clock"></i> æè¿°å€’è®¡æ—¶: ${left}ç§’`;

    if(state.descriptionTimer) clearInterval(state.descriptionTimer);
    state.descriptionTimer=setInterval(()=>{
        left--;
        timerDiv.innerHTML=`<i class="fas fa-clock"></i> æè¿°å€’è®¡æ—¶: ${left}ç§’`;
        if(left<=10){ timerDiv.style.color='var(--danger)'; if(left<=5) soundManager.playSound('warning'); }
        if(left<=0){
            clearInterval(state.descriptionTimer);
            timerDiv.remove();
            addLog('æè¿°æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨è·³è¿‡å½“å‰ç©å®¶','warning');
            speak('æè¿°æ—¶é—´å·²åˆ°ï¼Œå·²è‡ªåŠ¨è·³è¿‡');
            skipDescribe();
        }
    },1000);
}

/* æäº¤æè¿°ï¼ˆå…è®¸ç©ºï¼‰ */
function submitDescription(){
    const txt=document.getElementById('descriptionText').value.trim();
    const player=state.players.find(p=>p.id===state.currentDescriber);
    if(!player) return;
    state.descriptions.push({round:state.currentRound,playerId:state.currentDescriber,
        text:txt||'(æ— æè¿°)',role:player.type});
    if(state.settings.recordDescriptions){
        const list=document.getElementById('descriptionList');
        const col=player.type==='civilian'?'var(--success)':
                  player.type==='undercover'?'var(--danger)':'var(--primary)';
        list.innerHTML=`<div class="description-item" style="border-left:3px solid ${col};padding-left:5px;">
                <strong>ç¬¬${state.currentRound}è½®</strong> ${state.currentDescriber}å·: ${txt||'(æ— æè¿°)'}
            </div>`+list.innerHTML;
    }
    recordGameAction('describe',{playerId:state.currentDescriber,text:txt||'(æ— æè¿°)',role:player.type});
    addLog(`${state.currentDescriber}å·æè¿°: ${txt||'(æ— æè¿°)'}`,'info');
    document.getElementById('descriptionText').value='';

    if(state.descriptionTimer){ clearInterval(state.descriptionTimer); state.descriptionTimer=null; }
    const old=document.getElementById('describeTimeLeft');
    if(old) old.remove();

    // å®Œæˆæè¿° â†’ è·³åˆ°ä¸‹ä¸€ä½æˆ–æŠ•ç¥¨
    skipDescribe();
}

/* AI ç”Ÿæˆæè¿°ï¼ˆæ›´æ™ºèƒ½ï¼‰ */
function generateSmartDescription(word,role){
    if(AI_DESCRIPTORS[word]){
        const pool=AI_DESCRIPTORS[word];
        if(role==='undercover'){
            const prefixes=['ä¸€ç§','æŸä¸ª','ç±»ä¼¼çš„','å…³äº'];
            const suffixes=['ä¸œè¥¿','ç‰©å“','äº‹ç‰©','æ¦‚å¿µ','çš„'];
            const pre=prefixes[Math.floor(Math.random()*prefixes.length)];
            const suf=suffixes[Math.floor(Math.random()*suffixes.length)];
            const desc=pool[Math.floor(Math.random()*pool.length)];
            return `${pre}${desc}${suf}`;
        }else if(role==='blank'){
            const blanks=['æˆ‘ä¸å¤ªç¡®å®š...','è¿™ä¸ªè¯æœ‰ç‚¹éš¾æè¿°','è®©æˆ‘æƒ³æƒ³æ€ä¹ˆè¯´','å—¯...è®©æˆ‘æ€è€ƒä¸€ä¸‹','è¿™ä¸ªè¯è¯­å¾ˆç‰¹åˆ«'];
            return blanks[Math.floor(Math.random()*blanks.length)];
        }else{
            return pool[Math.floor(Math.random()*pool.length)];
        }
    }else{
        const generic={'civilian':['å¸¸è§çš„äº‹ç‰©','æ—¥å¸¸ç”Ÿæ´»ä¸­å¸¸è§','å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰'],
                       'undercover':['ä¸å¤ªç¡®å®šæ˜¯ä»€ä¹ˆ','å¯èƒ½æ˜¯å¸¸è§çš„ä¸œè¥¿','æè¿°æœ‰ç‚¹å›°éš¾'],
                       'blank':['æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆè¯´','è®©æˆ‘å†æƒ³æƒ³','è¿™ä¸ªè¯è¯­å¾ˆç‰¹åˆ«']};
        const arr=generic[role]||generic.civilian;
        return arr[Math.floor(Math.random()*arr.length)];
    }
}
function generateAIDescription(){
    const player=state.players.find(p=>p.id===state.currentDescriber);
    if(!player) return;
    const txt=generateSmartDescription(player.w,player.type);
    document.getElementById('descriptionText').value=txt;
}

/* è‡ªåŠ¨æè¿°ï¼ˆæŒ‰é’®ï¼‰ */
function autoDescribe(){
    const player=state.players.find(p=>p.id===state.currentDescriber);
    if(!player) return;
    const txt=generateSmartDescription(player.w,player.type);
    document.getElementById('descriptionText').value=txt;
    setTimeout(submitDescription,800);
}

/* è·³è¿‡æè¿°ï¼ˆå·²ä¿®å¤ï¼‰ */
function skipDescribe(){
    const alive=state.players.filter(p=>p.alive);
    if(alive.length===0){ endGame('error'); return; }

    recordGameAction('describe_complete',{playerId:state.currentDescriber});
    addLog(`${state.currentDescriber}å·ç©å®¶æè¿°å®Œæˆ`,'info');
    speak(`${state.currentDescriber}å·ç©å®¶æè¿°å®Œæˆ`);

    if(state.descriptionTimer){ clearInterval(state.descriptionTimer); state.descriptionTimer=null; }
    const old=document.getElementById('describeTimeLeft');
    if(old) old.remove();

    const idx=alive.findIndex(p=>p.id===state.currentDescriber);
    if(idx===-1){
        state.currentDescriber=alive[0].id;
        addLog(`æè¿°è€…å·²æ­»ï¼Œåˆ‡æ¢è‡³${state.currentDescriber}å·ç©å®¶`,'warning');
        updateDescribePrompt(); render(); startDescriptionTimeout();
        return;
    }

    if(idx<alive.length-1){
        state.currentDescriber=alive[idx+1].id;
        updateDescribePrompt(); render(); startDescriptionTimeout();
    }else{
        // æ‰€æœ‰äººå·²æè¿° â†’ æŠ•ç¥¨é˜¶æ®µ
        state.descriptionComplete=true;
        document.getElementById('descriptionInput').style.display='none';
        document.getElementById('skipDescribeBtn').style.display='none';
        document.getElementById('autoDescribeBtn').style.display='none';
        document.getElementById('voteId').style.display='inline-block';
        document.getElementById('voteBtn').style.display='inline-block';
        document.getElementById('guideText').innerText='æ‰€æœ‰ç©å®¶æè¿°å®Œæˆï¼Œè¯·è¿›è¡ŒæŠ•ç¥¨';
        document.getElementById('describePrompt').innerText='æŠ•ç¥¨é˜¶æ®µï¼šè¯·è¾“å…¥è¦æ·˜æ±°çš„ç©å®¶ç¼–å·å¹¶ç‚¹å‡»æŠ•ç¥¨';
        recordGameAction('describe_round_end',{round:state.currentRound});
        speak('æ‰€æœ‰ç©å®¶æè¿°å®Œæˆï¼Œè¯·å¼€å§‹æŠ•ç¥¨');
    }
}

/* ==================== 16ï¸âƒ£ æŠ•ç¥¨ ==================== */
function vote(){
    if(state.gamePhase==='describing' && !state.descriptionComplete){
        alert('è¯·å…ˆå®Œæˆæ‰€æœ‰æè¿°æˆ–ç‚¹å‡»ã€Œè·³è¿‡æè¿°ã€');
        return;
    }
    const id=+document.getElementById('voteId').value;
    const target=state.players.find(p=>p.id===id && p.alive);
    if(!target){
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ´»ç©å®¶ç¼–å·');
        soundManager.playSound('danger');
        return;
    }
    state.gamePhase='voting';
    updatePhaseIndicator();
    // 0 è¡¨ç¤ºæ— é™æŠ•ç¥¨
    if(state.settings.voteCount!==0){
        state.chances--;
    }
    target.alive=false;
    document.getElementById(`c-${id}`).classList.add('out');
    const roleName=target.type==='civilian'?'å¹³æ°‘':target.type==='undercover'?'å§åº•':'ç™½æ¿';
    recordGameAction('vote',{voted:id,role:target.type,round:state.currentRound,remainingChances:state.chances});
    speak(`æŠ•ç¥¨ç»“æŸï¼Œ${id}å·ç©å®¶çš„èº«ä»½æ˜¯${roleName}`);
    addLog(`${id}å·ç©å®¶è¢«æŠ•ç¥¨å‡ºå±€ï¼Œèº«ä»½ï¼š${roleName}`,'danger');
    addHistory(`ç¬¬${state.currentRound}è½®: ${id}å·è¢«æ·˜æ±° (${roleName})`);
    if(target.type==='undercover') soundManager.playSound('success');
    else soundManager.playSound('danger');

    document.getElementById('voteId').value='';

    updateStats(); updateRoleStats();
    startLastWords(id);
}

/* ==================== 17ï¸âƒ£ é—è¨€ ==================== */
function startLastWords(playerId){
    state.gamePhase='lastwords';
    updatePhaseIndicator();
    if(state.lastWordsTimer) clearInterval(state.lastWordsTimer);
    document.getElementById('lastWordsPlayer').textContent=playerId;
    document.getElementById('lastWordsCountdown').textContent=state.settings.lastWordsTime;
    document.getElementById('lastWords').classList.add('active');

    state.lastWordsPlayer=playerId;

    recordGameAction('last_words_start',{playerId});
    speak(`${playerId}å·ç©å®¶è¯·å‘è¡¨é—è¨€ï¼Œä½ æœ‰${state.settings.lastWordsTime}ç§’`);
    addLog(`${playerId}å·è¿›å…¥é—è¨€é˜¶æ®µ`,'warning');

    let left=state.settings.lastWordsTime;
    state.lastWordsTimer=setInterval(()=>{
        left--;
        document.getElementById('lastWordsCountdown').textContent=left;
        if(left<=0){
            clearInterval(state.lastWordsTimer);
            endLastWords();
        }
    },1000);
}
function endLastWords(){
    document.getElementById('lastWords').classList.remove('active');
    document.getElementById('voteBtn').disabled=false;
    document.getElementById('voteId').disabled=false;
    document.getElementById('skipDescribeBtn').disabled=false;
    document.getElementById('autoDescribeBtn').disabled=false;
    recordGameAction('last_words_end', {});
    addLog('é—è¨€é˜¶æ®µç»“æŸ','info');
    speak('é—è¨€æ—¶é—´ç»“æŸï¼Œæ¸¸æˆç»§ç»­');
    setTimeout(checkGameEnd,500);
}

/* ==================== 18ï¸âƒ£ æ£€æŸ¥æ¸¸æˆç»“æŸ ==================== */
function checkGameEnd(){
    const alive=state.players.filter(p=>p.alive);
    const und=alive.filter(p=>p.type==='undercover').length;
    const civ=alive.filter(p=>p.type==='civilian').length;

    if(und===0){
        // å¹³æ°‘èƒœ
        state.gameStats.civilianWins++; state.gameStats.totalGames++;
        state.gameStats.averageRounds=((state.gameStats.averageRounds*(state.gameStats.totalGames-1))+state.currentRound)/state.gameStats.totalGames;
        saveGameStats();
        recordGameAction('game_end',{winner:'civilian',rounds:state.currentRound});
        endGame('civilian');
    }else if(und>=civ){
        // å§åº•èƒœ
        state.gameStats.undercoverWins++; state.gameStats.totalGames++;
        state.gameStats.averageRounds=((state.gameStats.averageRounds*(state.gameStats.totalGames-1))+state.currentRound)/state.gameStats.totalGames;
        saveGameStats();
        recordGameAction('game_end',{winner:'undercover',rounds:state.currentRound});
        endGame('undercover');
    }else if(state.settings.voteCount!==0 && state.chances<=0){
        // æŠ•ç¥¨æ¬¡æ•°è€—å°½ï¼ˆä»…åœ¨æœ‰é™æŠ•ç¥¨æ—¶æ£€æŸ¥ï¼‰
        state.gameStats.undercoverWins++; state.gameStats.totalGames++;
        state.gameStats.averageRounds=((state.gameStats.averageRounds*(state.gameStats.totalGames-1))+state.currentRound)/state.gameStats.totalGames;
        saveGameStats();
        recordGameAction('game_end',{winner:'undercover',reason:'no_chances',rounds:state.currentRound});
        endGame('undercover');
    }else if(alive.length<=2){
        // ä¸¤åç©å®¶ä¸”å«å§åº• â†’ å§åº•èƒœ
        state.gameStats.undercoverWins++; state.gameStats.totalGames++;
        state.gameStats.averageRounds=((state.gameStats.averageRounds*(state.gameStats.totalGames-1))+state.currentRound)/state.gameStats.totalGames;
        saveGameStats();
        recordGameAction('game_end',{winner:'undercover',reason:'only_two_left',rounds:state.currentRound});
        endGame('undercover');
    }else{
        continueToNextRound();
    }
}

/* ==================== 19ï¸âƒ£ ä¸‹ä¸€è½® ==================== */
function continueToNextRound(){
    state.currentRound++;
    state.gamePhase='describing';
    state.descriptionComplete=false;
    const alive=state.players.filter(p=>p.alive);
    state.currentDescriber=alive[0].id;
    updatePhaseIndicator();
    document.getElementById('voteSection').style.display='none';
    document.getElementById('startDescribeBtn').style.display='block';
    document.getElementById('guideText').innerText=`ç¬¬${state.currentRound}è½®æè¿°å‡†å¤‡å¼€å§‹`;
    recordGameAction('new_round',{round:state.currentRound});
    speak(`æ¸¸æˆç»§ç»­ï¼Œå‰©ä½™${alive.filter(p=>p.type==='undercover').length}åå§åº•ï¼Œ${alive.length}åç©å®¶å­˜æ´»ï¼Œå‡†å¤‡è¿›å…¥ç¬¬${state.currentRound}è½®æè¿°`);
    render();
}

/* ==================== 20ï¸âƒ£ æš‚åœ/æ¢å¤ ==================== */
function pauseGame(){
    if(state.gamePhase==='setup'||state.gamePhase==='ended'||state.isReplaying) return;
    const wasPaused=state.gamePhase==='paused';
    if(!wasPaused){
        state.prevPhase=state.gamePhase;
        state.gamePhase='paused';
        if(state.lastWordsTimer) clearInterval(state.lastWordsTimer);
        document.getElementById('guideText').innerText='æ¸¸æˆå·²æš‚åœ';
        speak('æ¸¸æˆå·²æš‚åœ');
        addLog('æ¸¸æˆæš‚åœ','warning');
        recordGameAction('game_paused', {});
    }else{
        state.gamePhase=state.prevPhase;
        document.getElementById('guideText').innerText='æ¸¸æˆå·²æ¢å¤';
        speak('æ¸¸æˆç»§ç»­');
        addLog('æ¸¸æˆæ¢å¤','info');
        recordGameAction('game_resumed', {});
        if(state.gamePhase==='lastwords') startLastWords(state.lastWordsPlayer);
    }
    updatePhaseIndicator();
}

/* ==================== 21ï¸âƒ£ ç»“æŸæ¸¸æˆ ==================== */
function endGame(winner){
    state.gamePhase='ended';
    updatePhaseIndicator();
    state.players.forEach(p=>{
        const card=document.getElementById(`c-${p.id}`);
        if(!card.classList.contains('flipped')) card.classList.add('flipped');
    });
    document.getElementById('voteSection').style.display='none';
    document.getElementById('startDescribeBtn').style.display='none';
    const winText=winner==='civilian'?'å¹³æ°‘':'å§åº•';
    document.getElementById('guideText').innerText=`æ¸¸æˆç»“æŸ - ${winText}èƒœåˆ©ï¼`;
    addLog(`æ¸¸æˆç»“æŸï¼${winText}èƒœåˆ©ï¼`,'success');
    addLog(`æœ¬å±€è¯è¯­ï¼šå¹³æ°‘è¯ "${state.words[0]}"ï¼Œå§åº•è¯ "${state.words[1]}"`,'info');
    addLog(`æ¸¸æˆå›åˆæ•°ï¼š${state.currentRound}`,'info');
    addHistory(`æ¸¸æˆç»“æŸ: ${winText}èƒœ (${state.currentRound}è½®)`);
    speak(`æ¸¸æˆç»“æŸï¼${winText}èƒœåˆ©ï¼`);
    setTimeout(()=>{
        if(confirm(`æ¸¸æˆç»“æŸï¼${winText}èƒœåˆ©ï¼\n\næœ¬å±€è¯è¯­ï¼š\nå¹³æ°‘è¯ï¼š${state.words[0]}\nå§åº•è¯ï¼š${state.words[1]}\n\næ€»å›åˆæ•°ï¼š${state.currentRound}\n\næ˜¯å¦é‡æ–°å¼€å§‹ï¼Ÿ`))
            location.reload();
    },3000);
}

/* ==================== 22ï¸âƒ£ ç»Ÿè®¡é¢æ¿ ==================== */
function showGameStats(){
    const s=state.gameStats;
    const winCiv=s.totalGames?((s.civilianWins/s.totalGames)*100).toFixed(1):0;
    const winUnd=s.totalGames?((s.undercoverWins/s.totalGames)*100).toFixed(1):0;
    const html=`
        <div style="margin-bottom:15px;">
            <h3><i class="fas fa-chart-pie"></i> æ¸¸æˆç»Ÿè®¡æ¦‚è§ˆ</h3>
            <div class="stats">
                <div class="stat-item"><div class="stat-value">${s.totalGames}</div><div class="stat-label">æ€»æ¸¸æˆæ¬¡æ•°</div></div>
                <div class="stat-item"><div class="stat-value" style="color:var(--success)">${s.civilianWins}</div><div class="stat-label">å¹³æ°‘èƒœ</div></div>
                <div class="stat-item"><div class="stat-value" style="color:var(--danger)">${s.undercoverWins}</div><div class="stat-label">å§åº•èƒœ</div></div>
            </div>
        </div>
        <div style="margin-bottom:15px;">
            <h4>èƒœç‡ç»Ÿè®¡</h4>
            <div style="background:rgba(0,0,0,.3);padding:10px;border-radius:10px;">
                <div style="margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span>å¹³æ°‘èƒœç‡:</span><span>${winCiv}%</span>
                    </div>
                    <div style="height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;">
                        <div style="height:100%;width:${winCiv}%;background:var(--success);"></div>
                    </div>
                </div>
                <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span>å§åº•èƒœç‡:</span><span>${winUnd}%</span>
                    </div>
                    <div style="height:10px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;">
                        <div style="height:100%;width:${winUnd}%;background:var(--danger);"></div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <h4>å…¶ä»–ç»Ÿè®¡</h4>
            <div style="background:rgba(0,0,0,.3);padding:10px;border-radius:10px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    <span>å¹³å‡å›åˆæ•°:</span><span>${s.averageRounds.toFixed(1)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;">
                    <span>å†å²è®°å½•æ¡æ•°:</span><span>${s.history.length}</span>
                </div>
            </div>
        </div>`;
    const modal=document.createElement('div');
    modal.style.position='fixed'; modal.style.top='0'; modal.style.left='0';
    modal.style.width='100%'; modal.style.height='100%';
    modal.style.background='rgba(0,0,0,.8)'; modal.style.display='flex';
    modal.style.justifyContent='center'; modal.style.alignItems='center';
    modal.style.zIndex='2000'; modal.style.backdropFilter='blur(10px)';
    modal.innerHTML=`
        <div style="background:rgba(255,255,255,.1);padding:30px;border-radius:20px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,.2);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;color:var(--primary);"><i class="fas fa-chart-pie"></i> æ¸¸æˆç»Ÿè®¡</h2>
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" style="background:var(--danger);color:white;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:20px;">Ã—</button>
            </div>
            ${html}
            <div style="margin-top:20px;text-align:center;">
                <button class="btn" style="background:var(--danger);width:200px;" onclick="clearGameStats();document.body.removeChild(modal)">
                    <i class="fas fa-eraser"></i> æ¸…é›¶ç»Ÿè®¡è®°å½•
                </button>
            </div>
        </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click',e=>{ if(e.target===modal) document.body.removeChild(modal); });
}
function clearGameStats(){
    if(confirm('ç¡®å®šè¦æ¸…é›¶æ‰€æœ‰æ¸¸æˆç»Ÿè®¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')){
        state.gameStats={totalGames:0,civilianWins:0,undercoverWins:0,averageRounds:0,history:[]};
        saveGameStats();
        document.getElementById('historyContent').innerHTML='';
        addLog('æ¸¸æˆç»Ÿè®¡å·²æ¸…é›¶','success');
        speak('æ¸¸æˆç»Ÿè®¡å·²æ¸…é›¶');
    }
}

/* ==================== 23ï¸âƒ£ è¯´æ˜ä¹¦ ==================== */
function showManual(){ document.getElementById('manual').classList.add('show'); }
function closeManual(){ document.getElementById('manual').classList.remove('show'); }

/* ==================== 24ï¸âƒ£ å£°éŸ³æ§åˆ¶ ==================== */
document.getElementById('soundToggle').addEventListener('click',function(){
    state.settings.soundEnabled=!state.settings.soundEnabled;
    this.innerHTML=state.settings.soundEnabled?'<i class="fas fa-volume-up"></i> å£°éŸ³å¼€':'<i class="fas fa-volume-mute"></i> å£°éŸ³å…³';
    if(!state.settings.soundEnabled) window.speechSynthesis.cancel();
});

/* ==================== 25ï¸âƒ£ æ¸¸æˆåˆå§‹åŒ– ==================== */
function init(){
    const num=+document.getElementById('pNum').value;
    const diff=document.getElementById('difficulty').value;
    if(num<4||num>12){ alert('ç©å®¶äººæ•°å¿…é¡»åœ¨4-12ä¹‹é—´'); return; }

    // æ—¶é—´è®¾ç½®
    state.settings.viewTime=+document.getElementById('viewTime').value;
    state.settings.lastWordsTime=+document.getElementById('lastWordsTime').value;
    state.settings.describeTime=+document.getElementById('describeTime').value;

    // å¼€å…³
    state.settings.allowRevote=document.getElementById('allowRevote').checked;
    state.settings.autoSkipDescribe=document.getElementById('autoSkipDescribe').checked;
    state.settings.showRoleStats=document.getElementById('showRoleStats').checked;
    state.settings.recordDescriptions=document.getElementById('recordDescriptions').checked;
    state.settings.enableAI=document.getElementById('enableAI').checked;

    // æŠ•ç¥¨æ¬¡æ•°è‡ªå®šä¹‰ï¼ˆè‹¥ä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
    let voteInput=+document.getElementById('voteCount').value;
    if(isNaN(voteInput) || voteInput<0){
        voteInput=Math.ceil(num/2);
    }
    state.settings.voteCount=voteInput;
    state.chances=voteInput;

    // è¯åº“é€‰æ‹©
    let wordPairs=ENHANCED_DEFAULT_WORDS;
    const src=document.getElementById('wordSource').value;
    if(src==='custom'){
        const txt=document.getElementById('customWords').value.trim();
        if(txt){
            const lines=txt.split('\n').map(l=>l.trim()).filter(l=>l.includes(',')).map(l=>l.split(',').map(w=>w.trim()));
            if(lines.length) wordPairs=lines;
        }
    }else if(src==='ai'){
        const categories=[['åŠ¨ç‰©','æ¤ç‰©'],['é£Ÿç‰©','é¥®æ–™'],['èŒä¸š','å·¥å…·'],['åœ°ç‚¹','å»ºç­‘'],['è¿åŠ¨','æ¸¸æˆ'],['é¢œè‰²','å½¢çŠ¶']];
        const cat=categories[Math.floor(Math.random()*categories.length)];
        wordPairs=[[cat[0]+'A',cat[1]+'B']];
    }
    const pair=wordPairs[Math.floor(Math.random()*wordPairs.length)];
    state.words=pair;

    // è§’è‰²åˆ†é…
    let roles=[];
    if(diff==='custom'){
        const under=+document.getElementById('customUndercover').value;
        const blank=+document.getElementById('customBlank').value;
        for(let i=0;i<under;i++) roles.push({type:'undercover',w:pair[1]});
        for(let i=0;i<blank;i++) roles.push({type:'blank',w:'ç™½æ¿'});
    }else{
        switch(diff){
            case 'easy':   roles=[{type:'undercover',w:pair[1]}]; break;
            case 'normal': roles=[{type:'undercover',w:pair[1]},{type:'blank',w:'ç™½æ¿'}]; break;
            case 'hard':   roles=[{type:'undercover',w:pair[1]},{type:'undercover',w:pair[1]}]; break;
            case 'expert': roles=[{type:'undercover',w:pair[1]},{type:'undercover',w:pair[1]},{type:'blank',w:'ç™½æ¿'}]; break;
        }
    }
    while(roles.length<num) roles.push({type:'civilian',w:pair[0]});

    // éšæœºåˆ†é…ç­–ç•¥
    const rand=document.getElementById('wordRandomness').value;
    if(rand==='balanced'){
        roles.sort(()=>Math.random()-0.5);
    }else if(rand==='strategic'){
        const shuffled=[...roles];
        shuffled.sort(()=>Math.random()-0.5);
        let lastWasUnder=false;
        for(let i=0;i<shuffled.length;i++){
            if(shuffled[i].type==='undercover'){
                if(lastWasUnder){
                    for(let j=i+1;j<shuffled.length;j++){
                        if(shuffled[j].type!=='undercover'){
                            [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];
                            break;
                        }
                    }
                }
                lastWasUnder=true;
            }else lastWasUnder=false;
        }
        roles=shuffled;
    }else{
        // å®Œå…¨éšæœº
        for(let i=roles.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [roles[i],roles[j]]=[roles[j],roles[i]]; }
    }

    // ç”Ÿæˆç©å®¶å¯¹è±¡
    state.players=roles.map((r,i)=>({id:i+1,...r,alive:true,viewed:false}));
    state.viewCount=0; state.viewing=false; state.currentRound=1; state.currentDescriber=1;
    state.descriptionComplete=false; state.descriptions=[]; state.gameActions=[]; state.gamePhase='viewing';
    state.nextViewer=1;

    // è£åˆ¤é¢æ¿æ˜¾ç¤ºè¯è¯­
    document.getElementById('civilianWord').textContent=pair[0];
    document.getElementById('undercoverWord').textContent=pair[1];
    document.getElementById('blankWord').textContent='ç™½æ¿';

    document.getElementById('setup').style.display='none';
    document.getElementById('gameUI').style.display='block';
    if(state.settings.recordDescriptions){
        document.getElementById('descriptionHistory').style.display='block';
        document.getElementById('descriptionInput').style.display='block';
    }

    render(); updateStats(); updatePhaseIndicator(); updateRoleStats();
    recordGameAction('game_start',{players:num,difficulty:diff,words:pair});
    speak(`æ¸¸æˆå¼€å§‹ï¼Œå…±${num}åç©å®¶ï¼Œéš¾åº¦ï¼š${diff}ï¼Œè¯·ä¾æ¬¡ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹èº«ä»½è¯ã€‚`);
    addLog(`æ¸¸æˆåˆå§‹åŒ–å®Œæˆ - ${num}äººï¼Œéš¾åº¦ï¼š${diff}`,'success');
    addHistory(`æ–°æ¸¸æˆå¼€å§‹ - ${num}äºº`);
}

/* ==================== 26ï¸âƒ£ å¿«æ·é”® ==================== */
document.addEventListener('keydown',e=>{
    const tag=e.target.tagName;
    if(tag==='INPUT' || tag==='TEXTAREA' || e.target.isContentEditable) return;

    if(e.key==='Enter' && state.gamePhase==='describing' && state.descriptionComplete) vote();
    if(e.key===' ' && state.gamePhase==='describing'){ e.preventDefault(); skipDescribe(); }
    if(e.key===' ' && state.gamePhase==='viewing' && state.currentViewer){ e.preventDefault(); document.getElementById(`c-${state.currentViewer}`).click(); }
    if(e.key==='F9'){ e.preventDefault(); document.getElementById('refereeInfo').classList.toggle('show'); }
    if(e.key==='F10'){ e.preventDefault(); document.getElementById('gameHistory').classList.toggle('show'); }
    if(e.key==='F11'){ e.preventDefault(); showGameStats(); }
    if(e.key==='Escape'){ e.preventDefault(); pauseGame(); }
    if(e.ctrlKey && (e.key==='s'||e.key==='S')){ e.preventDefault(); saveGameState(); }
    if(e.ctrlKey && (e.key==='l'||e.key==='L')){ e.preventDefault(); loadGameState(); }
    if(e.ctrlKey && (e.key==='m'||e.key==='M')){ e.preventDefault(); showManual(); }
});

/* ==================== 27ï¸âƒ£ çª—å£ Resize ä¼˜åŒ– ==================== */
window.addEventListener('resize', throttle(render,100));

/* ==================== 28ï¸âƒ£ åˆå§‹æ¸²æŸ“ ==================== */
render();

/* ==================== 29ï¸âƒ£ PWA Service Worker ==================== */
if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(e=>console.log('SW æ³¨å†Œå¤±è´¥',e)));
}
window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault();
    const deferred=e;
    setTimeout(()=>{ if(confirm('æ˜¯å¦å°†ã€Œè°æ˜¯å§åº•ã€æ·»åŠ åˆ°ä¸»å±å¹•ä»¥è·å¾—æ›´å¥½ä½“éªŒï¼Ÿ')){ deferred.prompt(); deferred.userChoice.then(r=>{ if(r.outcome==='accepted') console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…'); }); } },30000);
});

/* ==================== 30ï¸âƒ£ å¼€åœºåŠ¨ç”» ==================== */
function playStartAnimation(){
    const overlay=document.getElementById('startOverlay');
    document.body.style.pointerEvents='none';
    setTimeout(()=>{
        overlay.style.transition='opacity .6s ease-out, transform .6s ease-out';
        overlay.style.opacity='0';
        overlay.style.transform='scale(0.9)';
        setTimeout(()=>{
            overlay.remove();
            document.body.style.pointerEvents='auto';
        },650);
    },1200);
}
window.addEventListener('load',()=>{
    if(!sessionStorage.getItem('hasPlayedStartAnim')){
        playStartAnimation();
        sessionStorage.setItem('hasPlayedStartAnim','1');
    }else{
        const o=document.getElementById('startOverlay');
        if(o) o.remove();
    }
});

/* ==================== 31ï¸âƒ£ è®°å½•æ¸¸æˆåŠ¨ä½œ ==================== */
function recordGameAction(type,payload){
    state.gameActions.push({type,timestamp:Date.now(),payload});
}
</script>

</body>
</html>
